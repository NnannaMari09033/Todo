<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Page</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        form { margin-bottom: 2em; }
        input { display: block; margin-bottom: 0.5em; }
    </style>
</head>
<body>
    <h1>API Test Page</h1>

    <h2>Login to get JWT Token</h2>
    <form id="login-form">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
        <button type="submit">Login</button>
    </form>
    <pre id="token-display"></pre>

    <hr>

    <h2>API Data</h2>
    <button id="fetch-data-btn" disabled>Fetch API Data</button>

    <h3>Todos</h3>
    <ul id="todos"></ul>

    <h3>Projects</h3>
    <ul id="projects"></ul>

    <h3>Tags</h3>
    <ul id="tags"></ul>

    <script>
        let accessToken = null;

        const loginForm = document.getElementById('login-form');
        const tokenDisplay = document.getElementById('token-display');
        const fetchDataBtn = document.getElementById('fetch-data-btn');

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;

            fetch('/api/token/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Login failed!');
                }
                return response.json();
            })
            .then(data => {
                accessToken = data.access;
                tokenDisplay.textContent = `Access Token: ${accessToken}\n\nRefresh Token: ${data.refresh}`;
                fetchDataBtn.disabled = false;
            })
            .catch(error => {
                tokenDisplay.textContent = error.message;
                accessToken = null;
                fetchDataBtn.disabled = true;
            });
        });

        fetchDataBtn.addEventListener('click', function() {
            if (accessToken) {
                fetchApiData('/api/todos/', 'todos');
                fetchApiData('/api/projects/', 'projects');
                fetchApiData('/api/tags/', 'tags');
            } else {
                alert('You must log in first to get a token.');
            }
        });

        function fetchApiData(url, elementId) {
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                },
            })
            .then(response => {
                if (response.status === 401) {
                    throw new Error('Token is invalid or expired.');
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const list = document.getElementById(elementId);
                list.innerHTML = '';
                data.results.forEach(item => { // DRF paginates results
                    const li = document.createElement('li');
                    li.textContent = item.name || item.title;
                    list.appendChild(li);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                const list = document.getElementById(elementId);
                list.innerHTML = `<li>Error: ${error.message}</li>`;
            });
        }
    </script>
</body>
</html>
